<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calibration Metrics for Random Forest and Generalized Linear Model Using French Insurance Data • CASdatasets</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="calibration_metrics_vignette_files/libs/quarto-html/popper.min.js"></script><script src="calibration_metrics_vignette_files/libs/quarto-html/tippy.umd.min.js"></script><link href="calibration_metrics_vignette_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="calibration_metrics_vignette_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link rel="stylesheet" href="style.scss">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibration Metrics for Random Forest and Generalized Linear Model Using French Insurance Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CASdatasets</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2-0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/CASdatasets.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/poisson_vignette.html">Frequency analysis of a French Motor Third Party Liability dataset</a></li>
    <li><a class="dropdown-item" href="../articles/quasi_poisson_vignette_ausprivauto0405.html">Frequency analysis of an Australian Motor Third Party Liability dataset</a></li>
    <li><a class="dropdown-item" href="../articles/gam_rc_phileas_vignette.html">Frequency analysis of a Belgian Motor Third Party Liability dataset</a></li>
    <li><a class="dropdown-item" href="../articles/zero_inflated_vignette.html">Frequency analysis of a Norwegian Motor Third Party Liability dataset</a></li>
    <li><a class="dropdown-item" href="../articles/zero_inflated_vignette_freMTPL.html">Frequency analysis with a Zero Inflated Regression of a French Motor Third Party Liability dataset</a></li>
    <li><a class="dropdown-item" href="../articles/triangle_vignette.html">Claims reserving of a French Motor Third Party Liability triangle dataset</a></li>
    <li><a class="dropdown-item" href="../articles/triangle_aids_vignette.html">Reserving exercice on reporting delays in AIDS Data</a></li>
    <li><a class="dropdown-item" href="../articles/mortality_vignette.html">Mortality Table Analysis in Actuarial Science: A Study on French Mortality Data</a></li>
    <li><a class="dropdown-item" href="../articles/calibration_metrics_vignette.html">Calibration Metrics for Random Forest and Generalized Linear Model Using French Insurance Data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dutangc/CASdatasets/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calibration Metrics for Random Forest and Generalized Linear Model Using French Insurance Data</h1>

      <p class="author">Julien Siharath</p>
      <p class="date">October, 2024</p>

      <small class="dont-index">Source: <a href="https://github.com/dutangc/CASdatasets/blob/master/vignettes/calibration_metrics_vignette.qmd" class="external-link"><code>vignettes/calibration_metrics_vignette.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="sec-equipy-introduction">Introduction<a class="anchor" aria-label="anchor" href="#sec-equipy-introduction"></a>
</h2>
<div class="cell">
<details class="code-fold"><summary>Session Settings</summary><div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Graphs----</span></span>
<span><span class="va">face_text</span><span class="op">=</span><span class="st">'plain'</span></span>
<span><span class="va">face_title</span><span class="op">=</span><span class="st">'plain'</span></span>
<span><span class="va">size_title</span> <span class="op">=</span> <span class="fl">14</span></span>
<span><span class="va">size_text</span> <span class="op">=</span> <span class="fl">11</span></span>
<span><span class="va">legend_size</span> <span class="op">=</span> <span class="fl">11</span></span>
<span></span>
<span><span class="va">global_theme</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">%+replace%</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span></span>
<span>      text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="va">size_text</span>, face <span class="op">=</span> <span class="va">face_text</span><span class="op">)</span>,</span>
<span>      legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>      legend.direction <span class="op">=</span> <span class="st">"horizontal"</span>, </span>
<span>      legend.box <span class="op">=</span> <span class="st">"vertical"</span>,</span>
<span>      legend.key <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="va">legend_size</span><span class="op">)</span>,</span>
<span>      axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="va">size_text</span>, face <span class="op">=</span> <span class="va">face_text</span><span class="op">)</span>, </span>
<span>      plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span></span>
<span>        size <span class="op">=</span> <span class="va">size_title</span>, </span>
<span>        hjust <span class="op">=</span> <span class="fl">0.5</span></span>
<span>      <span class="op">)</span>,</span>
<span>      plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Outputs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"digits"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<div class="cell">
<style type="text/css">
.justify {
  text-align: justify !important
}
</style>
</div>
<div>
<blockquote>
<p><strong>In Brief</strong></p>
<p>This vignette presents a calibration analysis of predictive models using the Brier score, Expected Calibration Error and reliability diagrams. We will focus on two models: Generalized Linear Model (GLM) and Random Forest, applied to the <code>freMTPLfreq</code> dataset from CASdatasets. Our goal is to evaluate how well these models are calibrated by comparing the predicted probabilities against actual outcomes in an insurance dataset.</p>
</blockquote>
</div>
<section class="level2"><h3 id="required-packages">Required Packages<a class="anchor" aria-label="anchor" href="#required-packages"></a>
</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># R package required to run Python code in a Quarto document</span></span>
<span></span>
<span><span class="va">required_R_libraries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"CASdatasets"</span>,</span>
<span>  <span class="st">"tidyverse"</span>,</span>
<span>  <span class="st">"ranger"</span>,</span>
<span>  <span class="st">"caret"</span>,</span>
<span>  <span class="st">"locfit"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">required_R_libraries</span>, <span class="va">library</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<div class="justify">
<p>The data used in this vignette comes from a French motor third-party liability insurance portfolio. The dataset, <code>freMPL1sub</code>, is part of the CASdatasets package in RStudio and contains details about contracts and clients obtained from a French insurance company, specifically related to a motor insurance portfolio.</p>
<p>This dataset is a subset of several datasets, such as <code>freMTPL1</code>, <code>freMTPL2</code>, and others, all of which are available in the casdatasets package. The subset has been filtered to include only instances where the exposure is greater than 0.9, allowing for the effective application of classification trees for more precise analysis.</p>
</div>
</section><section class="level2"><h3 id="dictionaries">Dictionaries<a class="anchor" aria-label="anchor" href="#dictionaries"></a>
</h3>
<p>The list of the 18 variables from the <code>freMPL1sub</code> dataset is reported in <a href="#tbl-dict-freMPL1sub" class="quarto-xref">Table 1</a>.</p>
<div class="justify">
<div id="tbl-dict-freMPL1sub" class="striped hover quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-dict-freMPL1sub-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 1: Content of the <code>freMPL1sub</code> dataset
</figcaption><div aria-describedby="tbl-dict-freMPL1sub-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table table-striped table-hover caption-top">
<colgroup>
<col style="width: 16%">
<col style="width: 11%">
<col style="width: 72%">
</colgroup>
<thead><tr class="header">
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>LicAge</td>
<td>Numeric</td>
<td>The driving licence age, in months</td>
</tr>
<tr class="even">
<td>VehAge</td>
<td>Numeric</td>
<td>Age of the vehicle in years</td>
</tr>
<tr class="odd">
<td>sensitive</td>
<td>Factor</td>
<td>Gender of the driver</td>
</tr>
<tr class="even">
<td>MariStat</td>
<td>Factor</td>
<td>Marital status of the driver</td>
</tr>
<tr class="odd">
<td>SocioCateg</td>
<td>Factor</td>
<td>Socio-economic category of the driver</td>
</tr>
<tr class="even">
<td>VehUsage</td>
<td>Factor</td>
<td>Usage of the vehicle</td>
</tr>
<tr class="odd">
<td>DrivAge</td>
<td>Numeric</td>
<td>Age of the driver in years</td>
</tr>
<tr class="even">
<td>HasKmLimit</td>
<td>boolean</td>
<td>Indicator if there’s a mileage limit</td>
</tr>
<tr class="odd">
<td>BonusMalus</td>
<td>Numeric</td>
<td>Bonus-malus coefficient</td>
</tr>
<tr class="even">
<td>VehBody</td>
<td>Factor</td>
<td>Body type of the vehicle</td>
</tr>
<tr class="odd">
<td>VehPrice</td>
<td>Factor</td>
<td>Price category of the vehicle</td>
</tr>
<tr class="even">
<td>VehEngine</td>
<td>Factor</td>
<td>Type of engine</td>
</tr>
<tr class="odd">
<td>VehEnergy</td>
<td>Factor</td>
<td>Type of fuel used (diesel or regular)</td>
</tr>
<tr class="even">
<td>VehMaxSpeed</td>
<td>Factor</td>
<td>Maximum speed category of the vehicle</td>
</tr>
<tr class="odd">
<td>VehClass</td>
<td>Factor</td>
<td>Vehicle class</td>
</tr>
<tr class="even">
<td>y</td>
<td>boolean</td>
<td>Response variable (if there is a claim)</td>
</tr>
<tr class="odd">
<td>RiskVar</td>
<td>Numeric</td>
<td>Risk variable</td>
</tr>
<tr class="even">
<td>Garage</td>
<td>Factor</td>
<td>Type of garage used</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</section><section class="level2"><h3 id="importation">Importation<a class="anchor" aria-label="anchor" href="#importation"></a>
</h3>
<div class="cell">
<details class="code-fold"><summary>Code for importing the dataset</summary><div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"freMPL1sub"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CONTRACTS</span> <span class="op">&lt;-</span> <span class="va">freMPL1sub</span></span>
<span></span>
<span><span class="co"># Create factors</span></span>
<span><span class="va">CONTRACTS.f</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">CONTRACTS</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    DrivAge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">DrivAge</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">17</span>, <span class="fl">22</span>, <span class="fl">26</span>, <span class="fl">42</span>, <span class="fl">74</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</details>
</div>
</section></section><section class="section level2"><h2 id="sec-equipy-purpose">Purpose<a class="anchor" aria-label="anchor" href="#sec-equipy-purpose"></a>
</h2>
<div class="justify">
<p>In insurance modeling, the accuracy of predicted probabilities is essential for effective decision-making. Calibration is a technique used to measure how well these predicted probabilities align with actual outcomes. Perfect calibration occurs when the predicted probability of an event matches the observed frequency of that event.</p>
<p>Mathematically, perfect calibration can be described as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ℙ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><mover><mi>p</mi><mo accent="true">̂</mo></mover><mo>=</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>p</mi></mrow><annotation encoding="application/x-tex">
\mathbb{P}(Y = 1 | \hat{p} = p) = p
</annotation></semantics></math></p>
<p>This equation implies that for a given predicted probability <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>, the actual probability of the event <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Y = 1</annotation></semantics></math> should also be <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>. In other words, if a model predicts a 30% probability of an event, that event should occur 30% of the time when the predicted probability is 30%.</p>
<p>In the context of insurance, achieving perfect calibration is beneficial for pricing policies effectively. Accurately calibrated models ensure that the premiums set for different risk categories reflect the true probabilities of claims occurring. For instance, if a model predicts a 60% chance of claims for a specific group, but the actual claim rate is significantly lower, it may lead to overpricing, driving away potential customers. Conversely, if the predicted probability is too low, insurers may underprice their products, risking financial losses when claims exceed expectations.</p>
<p>By ensuring that predicted probabilities are well-calibrated, insurers can make more informed pricing decisions, leading to a more competitive and sustainable pricing strategy. This not only enhances profitability but also helps maintain trust with policyholders, as fair pricing reflects accurate assessments of risk.</p>
<p>In this vignette, we evaluate the calibration of two models commonly applied in insurance risk prediction: a Generalized Linear Model (GLM) and a Random Forest. We aim to assess how accurately these models predict the likelihood of insurance claims using the following methods:</p>
<ul>
<li><p><strong>Brier Score</strong>: This metric evaluates the accuracy of probabilistic predictions by measuring the average squared difference between predicted probabilities and actual outcomes. A lower Brier score indicates better model performance <span class="citation" data-cites="brier1950verification">(<a href="#ref-brier1950verification" role="doc-biblioref"><strong>brier1950verification?</strong></a>)</span>.</p></li>
<li><p><strong>Expected Calibration Error (ECE)</strong>: ECE is a metric that quantifies the average deviation between predicted probabilities and actual outcomes across all instances. It is calculated by taking the weighted average of the absolute differences between predicted probabilities and observed frequencies, across all probability bins. The ECE provides a summary measure of calibration that is particularly useful when comparing different models. A lower ECE indicates better calibration, signifying that the predicted probabilities are closer to the actual event rates.</p></li>
<li><p><strong>Reliability Diagrams</strong>: Reliability Diagrams with Locfit Smoothing: These diagrams visually represent model calibration by plotting predicted probabilities against observed frequencies <span class="citation" data-cites="degroot1983comparison">(<a href="#ref-degroot1983comparison" role="doc-biblioref"><strong>degroot1983comparison?</strong></a>)</span>. A perfectly calibrated model will have points lying along the diagonal, indicating that predicted probabilities match actual outcomes. Any deviations from this line show whether the model overestimates or underestimates probabilities.</p></li>
</ul>
<p>To generate these reliability diagrams, we apply locfit smoothing <span class="citation" data-cites="loader1999local">(<a href="#ref-loader1999local" role="doc-biblioref"><strong>loader1999local?</strong></a>)</span>. Locfit is a non-parametric technique that produces flexible, locally weighted regression curves, smoothing out noise in the data and providing a refined calibration curve. By using locfit, we ensure that random fluctuations in the data do not obscure the true calibration performance, offering a clearer representation of how well the models align predicted probabilities with actual outcomes.</p>
<p>This vignette shows how calibration assesses whether predicted probabilities match actual outcomes, identifying if a model consistently overestimates or underestimates risk, which ultimately influences prediction-based decision-making.</p>
<p>For an exploration of the limitations of calibration metrics, refer to <span class="citation" data-cites="fernandes2024probabilistic">(<a href="#ref-fernandes2024probabilistic" role="doc-biblioref"><strong>fernandes2024probabilistic?</strong></a>)</span>, which highlights the necessity for recalibration methods discussed in <span class="citation" data-cites="machado2024uncertainty">(<a href="#ref-machado2024uncertainty" role="doc-biblioref"><strong>machado2024uncertainty?</strong></a>)</span>.</p>
</div>
</section><section class="section level2"><h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h2>
<section class="level2"><h3 id="random-forest-model">Random Forest Model<a class="anchor" aria-label="anchor" href="#random-forest-model"></a>
</h3>
<div class="justify">
<p>Random Forest, as described in <span class="citation" data-cites="breiman2001random">Breiman (<a href="#ref-breiman2001random" role="doc-biblioref">2001</a>)</span>, is a versatile machine learning technique that belongs to a class of ensemble learning methods. In this method, multiple decision trees are constructed during training, and their predictions are combined to produce a more accurate and stable model. Specifically, predictions are averaged for regression tasks and voted on for classification tasks.</p>
<p>The key idea behind Random Forest is to build a “forest” of decision trees, where each tree is trained on a random subset of the data and a random subset of the features. This randomness makes the model more robust and less prone to overfitting, which is a common issue with individual decision trees.</p>
<p>The process of building a Random Forest can be summarized in the following steps:</p>
<ol type="1">
<li>
<strong>Bootstrap Sampling</strong>: Multiple subsets of the original dataset are created using bootstrapping, which involves randomly selecting samples with replacement.</li>
<li>
<strong>Random Feature Selection</strong>: At each node of the tree, a random subset of features is selected, and the best feature from this subset is used to split the data.</li>
<li>
<strong>Tree Construction</strong>: Decision trees are constructed for each bootstrap sample, and these trees grow without pruning, resulting in very deep and complex structures.</li>
<li>
<strong>Aggregation</strong>: For regression tasks, predictions from all trees are averaged. For classification tasks, the most frequent prediction (mode) is selected.</li>
</ol>
<p>The Random Forest model can be mathematically represented as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>y</mi><mo accent="true">̂</mo></mover><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msub><mi>f</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\hat{y}_i = \frac{1}{T} \sum_{t=1}^{T} f_t(x_i)
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>y</mi><mo accent="true">̂</mo></mover><mi>i</mi></msub><annotation encoding="application/x-tex">\hat{y}_i</annotation></semantics></math> is the predicted value for the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>i</mi><mrow><mi>t</mi><mi>h</mi></mrow></msup><annotation encoding="application/x-tex">i^{th}</annotation></semantics></math> observation, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math> is the total number of trees, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>t</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_t(x_i)</annotation></semantics></math> represents the prediction of the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>t</mi><mrow><mi>t</mi><mi>h</mi></mrow></msup><annotation encoding="application/x-tex">t^{th}</annotation></semantics></math> tree.</p>
<p>One of the key advantages of Random Forest is its ability to handle large datasets with high dimensionality and missing data. The random selection of features at each split ensures that the model doesn’t rely too heavily on any single feature, reducing the risk of overfitting. Additionally, Random Forest provides a measure of <strong>feature importance</strong>, ranking the contribution of each feature to the model’s predictive power. This is particularly useful for understanding which features are most influential in making predictions.</p>
<p>In conclusion, Random Forest is widely appreciated for its high accuracy, robustness, and ease of use. It is highly effective for both regression and classification tasks and is especially valuable in situations with a large number of features or complex relationships between variables. For additional information, see <span class="citation" data-cites="breiman2001random">Breiman (<a href="#ref-breiman2001random" role="doc-biblioref">2001</a>)</span>.</p>
<section class="level2"><h3 id="generalized-linear-model-glm">Generalized Linear Model (GLM)<a class="anchor" aria-label="anchor" href="#generalized-linear-model-glm"></a>
</h3>
<p>A Generalized Linear Model (GLM), first formalized by <span class="citation" data-cites="nelder1972generalized">(<a href="#ref-nelder1972generalized" role="doc-biblioref"><strong>nelder1972generalized?</strong></a>)</span>, extends the linear model to allow for non-normal response variables. GLMs are widely used in insurance for modeling claims data, where the response variable might follow distributions such as Poisson or binomial.</p>
<p>GLMs consist of three main components, each playing a critical role in how the model relates the predictor variables to the response variable:</p>
<ol type="1">
<li><p><strong>Random Component</strong>: This specifies the probability distribution of the response variable. In GLMs, the response variable <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_i</annotation></semantics></math> is not assumed to be normally distributed, as it is in linear regression. Instead, the response can follow a variety of distributions from the exponential family, such as Poisson, binomial, or gamma. The choice of distribution depends on the nature of the outcome (e.g., count data, binary outcomes).</p></li>
<li><p><strong>Systematic Component</strong>: This represents the linear predictor, which is a linear combination of the explanatory variables (predictors). Formally, it is expressed as:</p></li>
</ol>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>η</mi><mi>i</mi></msub><mo>=</mo><msubsup><mi>x</mi><mi>i</mi><mi>T</mi></msubsup><mi>β</mi></mrow><annotation encoding="application/x-tex">
\eta_i = x_i^T \beta
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>i</mi></msub><annotation encoding="application/x-tex">x_i</annotation></semantics></math> is a vector of the explanatory variables for observation <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math> is a vector of coefficients. The linear predictor <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>T</mi></msubsup><mi>β</mi></mrow><annotation encoding="application/x-tex">x_i^T \beta</annotation></semantics></math> is the part of the model that combines the covariates to explain the variation in the response variable. This is similar to how a linear regression model operates but in the GLM, the connection between the linear predictor and the response is mediated by the link function.</p>
<ol start="3" type="1">
<li>
<strong>Link Function</strong>: The link function <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>⋅</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g(\cdot)</annotation></semantics></math> provides the bridge between the linear predictor and the mean of the response variable, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝔼</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbb{E}(y_i|x_i)</annotation></semantics></math>. It transforms the expected value of the response so that it can be modeled as a linear function of the predictors. The choice of link function depends on the distribution of the response. For example, a log link function is commonly used for count data (e.g., Poisson regression), and a logit link function is often used for binary outcomes (e.g., logistic regression).</li>
</ol>
<p>The GLM model can be expressed as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝔼</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mi>x</mi><mi>i</mi><mi>T</mi></msubsup><mi>β</mi></mrow><annotation encoding="application/x-tex">
g(\mathbb{E}(y_i|x_i)) = x_i^T \beta
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>⋅</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g(\cdot)</annotation></semantics></math> is the link function, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>T</mi></msubsup><mi>β</mi></mrow><annotation encoding="application/x-tex">x_i^T \beta</annotation></semantics></math> is the linear predictor, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝔼</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbb{E}(y_i|x_i)</annotation></semantics></math> is the expected outcome for observation <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.</p>
</section><section class="level2"><h3 id="extended-calibration-error-ece">Extended Calibration Error (ECE)<a class="anchor" aria-label="anchor" href="#extended-calibration-error-ece"></a>
</h3>
<p>Extended Calibration Error (ECE) is a metric used to evaluate the calibration of probabilistic predictions, especially in the context of insurance claims modeling. It quantifies the discrepancy between predicted probabilities and observed outcomes, providing insights into the reliability of a predictive model. ECE is particularly useful for assessing models that output probabilities, as it highlights potential biases in the predicted probabilities.</p>
<ol type="1">
<li>
<p><strong>Definition</strong>: ECE is defined as the weighted average of the absolute differences between predicted probabilities and observed frequencies of events. Formally, it is expressed as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">ECE</mtext><mo>=</mo><munderover><mo>∑</mo><mrow><mi>b</mi><mo>=</mo><mn>1</mn></mrow><mi>B</mi></munderover><mfrac><msub><mi>n</mi><mi>b</mi></msub><mi>n</mi></mfrac><mrow><mo stretchy="true" form="prefix">|</mo><msub><mtext mathvariant="normal">P</mtext><mrow><mtext mathvariant="normal">avg</mtext><mo>,</mo><mi>b</mi></mrow></msub><mo>−</mo><msub><mtext mathvariant="normal">O</mtext><mrow><mtext mathvariant="normal">avg</mtext><mo>,</mo><mi>b</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">
\text{ECE} = \sum_{b=1}^B \frac{n_b}{n} \left| \text{P}_{\text{avg},b} - \text{O}_{\text{avg},b} \right|
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> is the number of bins, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>b</mi></msub><annotation encoding="application/x-tex">n_b</annotation></semantics></math> is the number of observations in bin <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">P</mtext><mrow><mtext mathvariant="normal">avg</mtext><mo>,</mo><mi>b</mi></mrow></msub><annotation encoding="application/x-tex">\text{P}_{\text{avg},b}</annotation></semantics></math> is the average predicted probability in bin <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">O</mtext><mrow><mtext mathvariant="normal">avg</mtext><mo>,</mo><mi>b</mi></mrow></msub><annotation encoding="application/x-tex">\text{O}_{\text{avg},b}</annotation></semantics></math> is the observed frequency of events in bin <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math> is the total number of observations.</p>
</li>
<li><p><strong>Interpretation</strong>: ECE ranged provides from 0 to 1, it is a summary of how well predicted probabilities match the actual observed outcomes across different probability ranges. An ECE of zero signifies perfect calibration.</p></li>
</ol></section><section class="level2"><h3 id="brier-score">Brier Score<a class="anchor" aria-label="anchor" href="#brier-score"></a>
</h3>
<p>The Brier Score is a well-known metric for assessing the accuracy of probabilistic predictions. It is particularly useful in the insurance domain for evaluating the predictive performance of models that output probabilities of events, such as claim occurrences.</p>
<ol type="1">
<li>
<p><strong>Definition</strong>: The Brier Score is defined as the mean squared difference between predicted probabilities and the actual binary outcomes. It can be expressed mathematically as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Brier Score</mtext><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>−</mo><msub><mi>o</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">
\text{Brier Score} = \frac{1}{N} \sum_{i=1}^N (f_i - o_i)^2
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math> is the number of observations, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>i</mi></msub><annotation encoding="application/x-tex">f_i</annotation></semantics></math> is the predicted probability of the event for observation <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>o</mi><mi>i</mi></msub><annotation encoding="application/x-tex">o_i</annotation></semantics></math> is the actual outcome (1 if the event occurred, 0 otherwise).</p>
</li>
<li><p><strong>Interpretation</strong>: The Brier score ranges from 0 to 1 it measures the mean squared difference between predicted probabilities and actual outcomes. A lower Brier score indicates better calibration.</p></li>
</ol></section><section class="level2"><h3 id="reliability-diagram-with-locfit-smoothing">Reliability Diagram with Locfit Smoothing<a class="anchor" aria-label="anchor" href="#reliability-diagram-with-locfit-smoothing"></a>
</h3>
<p>The Reliability Diagram is a graphical representation used to assess the calibration of probabilistic predictions visually. It plots the predicted probabilities against the observed frequencies of events, providing insights into how well the model calibrates its probability outputs.</p>
<ol type="1">
<li><p><strong>Construction</strong>: To construct a Reliability Diagram, predicted probabilities are binned, and the average predicted probability and observed frequency are calculated for each bin. This is typically plotted as a scatter plot of predicted probabilities versus observed proportions.</p></li>
<li>
<p><strong>Locfit Smoothing</strong>: To enhance the visual interpretation of the Reliability Diagram, Locfit smoothing can be applied. Locfit is a local regression method that fits a smooth curve to the binned data, making it easier to identify trends and deviations from perfect calibration (the 45-degree line).</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Locfit</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>p</mi><mo accent="true">̂</mo></mover><mi>b</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>B</mi></munderover><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>y</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">
\text{Locfit}(\hat{p}_b) = \sum_{j=1}^B w_{ij} y_j
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">w_{ij}</annotation></semantics></math> are the weights based on the distances of the observations to the target bin, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>j</mi></msub><annotation encoding="application/x-tex">y_j</annotation></semantics></math> represents the observed outcomes.</p>
</li>
<li><p><strong>Interpretation</strong>: In the Reliability Diagram, points lying on the diagonal line indicate perfect calibration. Deviations above this line suggest overconfidence (predicted probabilities are too high), while points below indicate underconfidence (predicted probabilities are too low). The Locfit curve can help to visualize the overall calibration trend and highlight areas needing improvement.</p></li>
</ol></section>
</div>
</section></section><section class="section level2"><h2 id="sec-equipy-estimation">Calibration Evaluation<a class="anchor" aria-label="anchor" href="#sec-equipy-estimation"></a>
</h2>
<section class="level3"><h4 id="data-preprocessing">Data preprocessing<a class="anchor" aria-label="anchor" href="#data-preprocessing"></a>
</h4>
<p>We split the data into training and calibration sets. The training set is utilized to fit the models, while the calibration set is used for the calibration process.</p>
<div class="cell">
<details class="code-fold"><summary>Splitting Data into Training and Calibration Sets</summary><div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">23</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trainIndex</span> <span class="op">&lt;-</span> <span class="fu">createDataPartition</span><span class="op">(</span><span class="va">CONTRACTS.f</span><span class="op">$</span><span class="va">y</span>, p <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                                  list <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                                  times <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataTrain</span> <span class="op">&lt;-</span> <span class="va">CONTRACTS.f</span><span class="op">[</span><span class="va">trainIndex</span>, <span class="op">]</span>  <span class="co"># Training set</span></span>
<span><span class="va">dataCalibration</span> <span class="op">&lt;-</span> <span class="va">CONTRACTS.f</span><span class="op">[</span><span class="op">-</span><span class="va">trainIndex</span>, <span class="op">]</span>  <span class="co"># Calibration set</span></span>
<span></span>
<span><span class="va">dataTrain</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">dataTrain</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
</section><section class="level3"><h4 id="training-the-randomforest-model">Training the RandomForest Model<a class="anchor" aria-label="anchor" href="#training-the-randomforest-model"></a>
</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_model</span> <span class="op">&lt;-</span> <span class="fu">ranger</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span><span class="va">.</span>,</span>
<span>                   num.trees <span class="op">=</span> <span class="fl">500</span>,   <span class="co"># Number of trees</span></span>
<span>                   mtry <span class="op">=</span> <span class="fl">2</span>,          <span class="co"># Number of features to try at each split</span></span>
<span>                   min.node.size <span class="op">=</span> <span class="fl">1</span>, <span class="co"># Minimum size of terminal nodes</span></span>
<span>                   importance <span class="op">=</span> <span class="st">'impurity'</span>, </span>
<span>                   data <span class="op">=</span> <span class="va">dataTrain</span>,</span>
<span>                   write.forest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level3"><h4 id="training-the-glm-model">Training the GLM Model<a class="anchor" aria-label="anchor" href="#training-the-glm-model"></a>
</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">dataTrain</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h3 id="calibration-metrics">Calibration Metrics<a class="anchor" aria-label="anchor" href="#calibration-metrics"></a>
</h3>
<div class="panel-tabset">
<ul id="tabset-1" class="panel-tabset-tabby">
<li><a data-tabby-default="" href="#tabset-1-1">Brier Score</a></li>
<li><a href="#tabset-1-2">ECE</a></li>
</ul>
<ul class="nav nav-tabs" id="NA" role="tablist"><li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#NA" id="NA-tab" type="button" role="tab" aria-controls="NA" aria-selected="true" class="active nav-link">
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#</span></span>
<span><span class="co"># Make predictions for both models</span></span>
<span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">rf_pred_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rf_model</span>, <span class="va">dataCalibration</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">glm_pred_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">glm_model</span>, <span class="va">dataCalibration</span>,type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate Brier Score for Random Forest model</span></span>
<span><span class="va">brier_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">rf_pred_prob</span> <span class="op">-</span> <span class="va">dataCalibration</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate Brier Score for GLM model</span></span>
<span><span class="va">brier_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">glm_pred_prob</span> <span class="op">-</span> <span class="va">dataCalibration</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The brier score for the random forest model is 0.07<br>
The brier score for the glm model is 0.08</p>
</button></li></ul>
<div class="tab-content"><div class="active  tab-pane" id="NA" role="tabpanel" aria-labelledby="NA-tab">

<div id="tabset-1-2">
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to calculate ECE</span></span>
<span><span class="va">calculate_ece</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">predictions</span>, <span class="va">actuals</span>, <span class="va">n_bins</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create bins</span></span>
<span>  <span class="va">bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_bins</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">bin_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_bins</span><span class="op">)</span></span>
<span>  <span class="va">bin_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_bins</span><span class="op">)</span></span>
<span>  <span class="va">bin_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_bins</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_bins</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Find indices of predictions in the current bin</span></span>
<span>    <span class="va">in_bin</span> <span class="op">&lt;-</span> <span class="va">predictions</span> <span class="op">&gt;=</span> <span class="va">bins</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">predictions</span> <span class="op">&lt;</span> <span class="va">bins</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">bin_counts</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">in_bin</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Avoid division by zero</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">bin_counts</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">bin_means</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">predictions</span><span class="op">[</span><span class="va">in_bin</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">bin_obs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">actuals</span><span class="op">[</span><span class="va">in_bin</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Calculate ECE</span></span>
<span>  <span class="va">ece</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">bin_counts</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">bin_counts</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bin_means</span> <span class="op">-</span> <span class="va">bin_obs</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">ece</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Calculate ECE for GLM model</span></span>
<span><span class="va">ece_glm</span> <span class="op">&lt;-</span> <span class="fu">calculate_ece</span><span class="op">(</span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">glm_pred_prob</span>, <span class="va">dataCalibration</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">ece_rf</span> <span class="op">&lt;-</span> <span class="fu">calculate_ece</span><span class="op">(</span><span class="va">dataCalibration</span><span class="op">$</span><span class="va">rf_pred_prob</span>, <span class="va">dataCalibration</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The ECE for the random forest model is 0.03<br>
The ECE for the glm model is 0.01</p>
</div>
</div></div>
</div>
</section></section><section class="section level2"><h2 id="visualizations">Visualizations<a class="anchor" aria-label="anchor" href="#visualizations"></a>
</h2>
<div class="panel-tabset">
<ul id="tabset-2" class="panel-tabset-tabby">
<li><a data-tabby-default="" href="#tabset-2-1">Reliability Diagram for the Random Forest</a></li>
<li><a href="#tabset-2-2">Reliability Diagram for the GLM Model</a></li>
</ul>
<ul class="nav nav-tabs" id="NA" role="tablist"><li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#NA" id="NA-tab" type="button" role="tab" aria-controls="NA" aria-selected="true" class="active nav-link">
<div class="cell">
<details class="code-fold"><summary>Code for the reliability diagram function</summary><div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to create a reliability diagram with locfit smoothing</span></span>
<span></span>
<span><span class="va">create_reliability_diagram</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">pred_col</span>, <span class="va">obs_col</span>, <span class="va">n_bins</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create bins for predicted probabilities</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">pred_col</span><span class="op">]</span><span class="op">]</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>                                                 length.out <span class="op">=</span> <span class="va">n_bins</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                                 include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate mean predicted and actual probabilities per bin</span></span>
<span>  <span class="va">bin_summary</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">bin</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span></span>
<span>      mean_pred_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">pred_col</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      mean_obs_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">obs_col</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Use locfit to smooth the observed probabilities based on predicted probabilities</span></span>
<span>  <span class="va">fit_locfit</span> <span class="op">&lt;-</span> <span class="fu">locfit</span><span class="op">(</span><span class="va">mean_obs_prob</span> <span class="op">~</span> <span class="va">mean_pred_prob</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">bin_summary</span>,</span>
<span>                       weights <span class="op">=</span> <span class="va">bin_summary</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Generate smoothed probabilities for plotting</span></span>
<span>  <span class="va">smooth_obs_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_locfit</span>, newdata <span class="op">=</span> <span class="va">bin_summary</span><span class="op">$</span><span class="va">mean_pred_prob</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Plot the reliability diagram</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">bin_summary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_pred_prob</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">mean_obs_prob</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#1E88E5"</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">smooth_obs_prob</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># 45-degree reference line</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="st">"Reliability Diagram with Locfit Smoothing"</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"Mean Observed Probability"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">global_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">coord_fixed</span><span class="op">(</span>ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlim</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylim</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">create_reliability_diagram</span><span class="op">(</span><span class="va">dataCalibration</span>, <span class="st">"rf_pred_prob"</span>, <span class="st">"y"</span>, n_bins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="calibration_metrics_vignette_files/figure-html/reliability-rf-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
</button></li></ul>
<div class="tab-content"><div class="active  tab-pane" id="NA" role="tabpanel" aria-labelledby="NA-tab">

<div id="tabset-2-2">
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">create_reliability_diagram</span><span class="op">(</span><span class="va">dataCalibration</span>, <span class="st">"glm_pred_prob"</span>, <span class="st">"y"</span>, n_bins <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="calibration_metrics_vignette_files/figure-html/reliability-glm-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div></div>
</div>
</section><section class="section level2"><h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-breiman2001random" class="csl-entry" role="listitem">
Breiman, Leo. 2001. <span>“Random Forests.”</span> <em>Machine Learning</em> 45: 5–32.
</div>
</div>
</section><section class="section level2"><h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<div class="justify">
<p>For additional datasets with similar occurrence structures, see <a href="https://dutangc.github.io/CASdatasets/reference/credit.html" class="external-link"><code>credit</code></a> (import with <code>data("credit")</code>): German Credit dataset, or <a href="https://dutangc.github.io/CASdatasets/reference/uslapseagent.html" class="external-link"><code>uslapseagent</code></a>: United States lapse dataset from tied-agent channel (import with <code>data("uslapseagent")</code>),</p>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="http://dutangc.free.fr" class="external-link">Christophe Dutang</a>, <a href="https://freakonometrics.github.io" class="external-link">Arthur Charpentier</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
